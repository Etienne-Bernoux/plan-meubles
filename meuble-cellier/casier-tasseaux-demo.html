<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Casier tasseaux — Démo bouteilles</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { overflow: hidden; background: #1a1a2e; font-family: 'Segoe UI', sans-serif; }
canvas { display: block; }
#overlay {
  position: absolute; top: 15px; left: 15px;
  background: rgba(0,0,0,0.7); color: #eee;
  padding: 15px 20px; border-radius: 10px;
  font-size: 13px; line-height: 1.8;
  backdrop-filter: blur(10px);
  max-width: 400px;
}
#overlay h2 { font-size: 16px; margin-bottom: 8px; color: #f0a040; }
#controls {
  position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
  z-index: 10; display: flex; gap: 8px;
}
#controls button {
  background: #f0a040; border: none; color: #1a1a2e; padding: 8px 16px;
  border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;
}
#controls button:hover { background: #ffb860; }
</style>
</head>
<body>

<div id="overlay">
  <h2>Casier à tasseaux — Bouteilles 75cl</h2>
  <span style="color:#aaa;">
  Tasseaux horizontaux espacés de ~9cm.<br>
  Les bouteilles roulent entre 2 tasseaux.<br>
  2 rangées en profondeur (avant + arrière).<br><br>
  <span style="color:#C9A86C;">Beige clair</span> = tasseaux 30×30mm (chutes)<br>
  <span style="color:#C4A265;">Beige foncé</span> = montants OSB 18mm<br>
  <span style="color:#2d5a1b;">Vert</span> = bouteilles 75cl (Ø7.5cm × 30cm)<br><br>
  Simple, dense, économe en matière
  </span>
</div>

<div id="controls">
  <button id="btnRotate">Stopper rotation</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script>
// ══════════════════════════════════════════════════
// SCENE
// ══════════════════════════════════════════════════
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x1a1a2e);
const camera = new THREE.PerspectiveCamera(40, innerWidth/innerHeight, 1, 2000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 0.5));
const sun = new THREE.DirectionalLight(0xffffff, 0.7);
sun.position.set(100, 200, 150); scene.add(sun);
scene.add(new THREE.DirectionalLight(0xffffff, 0.3)).position.set(-80, 60, -80);

// ══════════════════════════════════════════════════
// MATÉRIAUX
// ══════════════════════════════════════════════════
const matTass = new THREE.MeshStandardMaterial({ color: 0xC9A86C, roughness: 0.6 });
const matOSB = new THREE.MeshStandardMaterial({ color: 0xC4A265, roughness: 0.8 });
const matBottle = new THREE.MeshStandardMaterial({ color: 0x2d5a1b, transparent: true, opacity: 0.75 });
const matCap = new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.6, roughness: 0.3 });

// ══════════════════════════════════════════════════
// DIMENSIONS (cm)
// ══════════════════════════════════════════════════
const T = 1.8;            // épaisseur OSB
const TASS = 3;           // section tasseau 30×30mm
const BOTTLE_D = 7.5;     // diamètre bouteille
const BOTTLE_R = BOTTLE_D / 2;
const BOTTLE_L = 30;      // longueur bouteille

// Espacement entre tasseaux : bouteille doit reposer entre 2 tasseaux
// Écart entre bords intérieurs des tasseaux < diamètre bouteille
// pour que la bouteille ne tombe pas, mais assez large pour se caler
const GAP = 6;            // écart libre entre 2 tasseaux (< 7.5cm)
const STEP = GAP + TASS;  // pas de répétition = 9cm

// Zone dispo : 116.4cm large × 48.2cm haut × 50cm profondeur
const ZONE_W = 116;
const ZONE_H = 48;
const DEPTH = 48;

const ROWS = Math.floor(ZONE_H / STEP);  // 5 rangées de bouteilles
const BOTTLES_PER_ROW = Math.floor(ZONE_W / (BOTTLE_D + 1));  // ~14 bouteilles par rangée

// 2 rangées de tasseaux en profondeur
const Z_BACK = 6;
const Z_FRONT = 38;
const Z_MID = (Z_BACK + Z_FRONT) / 2;

const group = new THREE.Group();

// ══════════════════════════════════════════════════
// FONCTIONS
// ══════════════════════════════════════════════════
function box(w, h, d, x, y, z, mat) {
  const geo = new THREE.BoxGeometry(w, h, d);
  const mesh = new THREE.Mesh(geo, mat);
  mesh.position.set(x, y, z);
  group.add(mesh);
  return mesh;
}

function makeBottle(x, y, z) {
  const bodyGeo = new THREE.CylinderGeometry(BOTTLE_R, BOTTLE_R, BOTTLE_L - 5, 12);
  bodyGeo.rotateX(Math.PI / 2);
  const body = new THREE.Mesh(bodyGeo, matBottle);
  body.position.set(x, y, z);
  group.add(body);

  const neckGeo = new THREE.CylinderGeometry(1.0, BOTTLE_R * 0.55, 5, 10);
  neckGeo.rotateX(Math.PI / 2);
  const neck = new THREE.Mesh(neckGeo, matBottle);
  neck.position.set(x, y, z + (BOTTLE_L - 5) / 2 + 2.5);
  group.add(neck);

  const capGeo = new THREE.SphereGeometry(1.1, 8, 8);
  const cap = new THREE.Mesh(capGeo, matCap);
  cap.position.set(x, y, z + BOTTLE_L / 2 + 0.3);
  group.add(cap);
}

// ══════════════════════════════════════════════════
// CONSTRUCTION
// ══════════════════════════════════════════════════

// Base OSB
box(ZONE_W + 4, T, DEPTH, 0, -T/2, DEPTH/2, matOSB);

// Montants latéraux OSB (gauche et droite)
box(T, ZONE_H, DEPTH, -ZONE_W/2 - T/2, ZONE_H/2, DEPTH/2, matOSB);
box(T, ZONE_H, DEPTH,  ZONE_W/2 + T/2, ZONE_H/2, DEPTH/2, matOSB);

// Tasseaux horizontaux — 2 rangées en profondeur (avant + arrière)
// Chaque paire de tasseaux forme un berceau pour les bouteilles
const nbTass = ROWS + 1;  // N+1 tasseaux pour N rangées

for (let i = 0; i <= ROWS; i++) {
  const y = i * STEP + TASS/2;  // position Y du centre du tasseau

  // Tasseau arrière (sur toute la largeur)
  box(ZONE_W, TASS, TASS, 0, y, Z_BACK, matTass);
  // Tasseau avant
  box(ZONE_W, TASS, TASS, 0, y, Z_FRONT, matTass);
}

// Bouteilles — posées entre chaque paire de tasseaux
// La bouteille repose sur 2 tasseaux. Son centre Y est entre les 2 tasseaux
// Elle touche le bord supérieur du tasseau du bas et le bord inférieur du tasseau du haut
// Centre Y = tasseau_bas.top + BOTTLE_R * cos(asin(GAP/2 / BOTTLE_R))
// Simplification : la bouteille repose à ~BOTTLE_R au-dessus du milieu du gap

for (let row = 0; row < ROWS; row++) {
  const tassTopY = row * STEP + TASS;  // bord supérieur du tasseau du bas
  // La bouteille touche les 2 tasseaux. Dans le gap de 6cm avec bouteille de 7.5cm:
  // sin(alpha) = (GAP/2) / BOTTLE_R → alpha = asin(3/3.75) = 53.1°
  // Centre bouteille = tassTopY + BOTTLE_R * cos(alpha)
  const alpha = Math.asin((GAP / 2) / BOTTLE_R);
  const by = tassTopY + BOTTLE_R * Math.cos(alpha);

  for (let b = 0; b < BOTTLES_PER_ROW; b++) {
    const bx = -ZONE_W/2 + BOTTLE_R + 1 + b * (BOTTLE_D + 1);
    makeBottle(bx, by, Z_MID);
  }
}

// Centrer le groupe
group.position.set(0, 0, -DEPTH/2);
scene.add(group);

// Grille au sol
const grid = new THREE.GridHelper(200, 20, 0x333355, 0x222244);
grid.position.y = -T;
scene.add(grid);

// ══════════════════════════════════════════════════
// CAMERA — OrbitControls
// ══════════════════════════════════════════════════
camera.position.set(70, 40, 90);
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.target.set(0, ZONE_H / 2, 0);
controls.enableDamping = true;
controls.dampingFactor = 0.08;
controls.autoRotate = true;
controls.autoRotateSpeed = 0.8;
controls.update();

document.getElementById('btnRotate').addEventListener('click', function() {
  controls.autoRotate = !controls.autoRotate;
  this.textContent = controls.autoRotate ? 'Stopper rotation' : 'Reprendre rotation';
});

addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

(function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
})();
</script>
</body>
</html>
